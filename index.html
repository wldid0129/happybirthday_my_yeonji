<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì—°ì§€ì˜ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŠ¸ë¦¬</title>

  <style>
    body{
      margin:0;
      background: radial-gradient(circle at 20% 10%, rgba(255,255,255,.16), transparent 42%),
                  linear-gradient(135deg, #b81d24 0%, #0b6b3a 100%);
      color:#fff;
      font-family: 'Apple SD Gothic Neo','Noto Sans KR',system-ui,sans-serif;
      overflow-x:hidden;
    }

    /* ëˆˆ ìº”ë²„ìŠ¤ */
    #snow{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index: 2;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 28px 16px 80px;
      text-align:center;
      position: relative;
      z-index: 3;
    }

    h1{ margin:10px 0 6px; }
    .sub{ font-size:14px; opacity:.85; margin-bottom:12px; }

    .musicBtn{
      margin: 10px auto 16px;
      padding:10px 14px;
      border:0;
      border-radius:999px;
      background: rgba(255,255,255,.18);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      backdrop-filter: blur(6px);
    }

    /* íŠ¸ë¦¬ ë¬´ëŒ€: ì •ë°©í–¥(1:1) */
    .stage{
      position:relative;
      width:min(520px, 92vw);
      aspect-ratio:1/1;
      margin:0 auto;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      border-radius:22px;
      box-shadow:0 18px 50px rgba(0,0,0,.25);
      overflow:hidden;
    }

    .tree{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: contain;
      z-index: 1;
      filter: drop-shadow(0 16px 30px rgba(0,0,0,.22));
    }

    /* ë°˜ì§ì´ ì „êµ¬ */
    .light{
      position:absolute;
      width:10px;
      height:10px;
      border-radius:50%;
      background: rgba(255,255,255,.95);
      box-shadow: 0 0 14px rgba(255,255,255,.95);
      animation: twinkle 1.4s infinite ease-in-out;
      opacity: .75;
      z-index: 2;
    }
    @keyframes twinkle{
      0%{ transform: scale(.7); opacity:.35; }
      50%{ transform: scale(1.3); opacity:1; }
      100%{ transform: scale(.7); opacity:.35; }
    }

    /* ì˜¤ë„ˆë¨¼íŠ¸(ì‚¬ì§„) */
    .ornament{
      position:absolute;
      width:86px;
      height:86px;
      border-radius:50%;
      overflow:hidden;
      cursor:pointer;
      z-index: 3;
      transform: translate(-50%, -50%);
      box-shadow: 0 12px 24px rgba(0,0,0,.35);
      border: 3px solid rgba(255,255,255,.9);
      background:#fff;
      transition: transform .15s ease;
    }
    .ornament:hover{
      transform: translate(-50%, -50%) scale(1.04);
    }
    .ornament img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }

    /* ê³ ë¦¬(ì˜¤ë„ˆë¨¼íŠ¸ ëŠë‚Œ) */
    .hook{
      position:absolute;
      width:18px;
      height:18px;
      border-radius:50%;
      border: 2px solid rgba(255,255,255,.95);
      background: rgba(0,0,0,.10);
      top:-14px;
      left:50%;
      transform: translateX(-50%);
      box-shadow: 0 6px 14px rgba(0,0,0,.25);
    }
    .string{
      position:absolute;
      width:2px;
      height:22px;
      background: rgba(255,255,255,.75);
      top:-22px;
      left:50%;
      transform: translateX(-50%);
      border-radius: 2px;
    }

    /* í¸ì§€ ì•„ì´ì½˜ ë°°ì§€ */
    .note{
      position:absolute;
      right:-6px;
      bottom:-6px;
      width:30px;
      height:30px;
      border-radius:50%;
      background:#fff;
      color:#111;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      box-shadow:0 6px 14px rgba(0,0,0,.25);
    }

    /* ëª¨ë‹¬ */
    .modalBack{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index: 20;
    }
    .modal{
      width:min(720px, 96vw);
      background: rgba(255,255,255,.96);
      color:#222;
      border-radius:18px;
      padding:16px;
      text-align:left;
      box-shadow: 0 18px 70px rgba(0,0,0,.35);
    }
    .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .close{
      border:0;
      background:#eee;
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
    }
    .letters{
      max-height:280px;
      overflow:auto;
      background:#f7f7f7;
      border-radius:12px;
      padding:10px;
      margin-bottom:10px;
    }
    .item{
      background:#fff;
      border-radius:12px;
      padding:10px;
      margin-bottom:8px;
      font-size:14px;
    }
    .meta{ font-size:12px; opacity:.6; margin-bottom:4px; }
    .msg{ white-space: pre-line; line-height: 1.7; }

    .itemTop{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.deleteBtn{
  border:0;
  background:transparent;
  cursor:pointer;
  font-size:16px;
  opacity:.5;
}

.deleteBtn:hover{
  opacity:1;
}


    .editBtn{
    margin-top:8px;
    border:0;
    padding:7px 10px;
    border-radius:10px;
    cursor:pointer;
    background:#eee;
    }

    textarea,input{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid #ccc;
      margin-bottom:8px;
      font-size:14px;
      box-sizing: border-box;
    }
    button.send{
      width:100%;
      padding:10px;
      border-radius:999px;
      border:0;
      background:#111;
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }

    .hint{
      margin-top: 12px;
      font-size: 13px;
      opacity: .85;
    }
  </style>
</head>

<body>
  <canvas id="snow"></canvas>

  <div class="wrap">
    <h1>ğŸ„ ì—°ì§€ì˜ íŠ¸ë¦¬ í¸ì§€í•¨ ğŸ„</h1>
    <div class="sub">ì˜¤ë„ˆë¨¼íŠ¸ë¥¼ ëˆŒëŸ¬ì„œ í¸ì§€ë¥¼ í™•ì¸í•´ì¤˜!</div>

    <button id="musicBtn" class="musicBtn">ìŒì•… ì¼œê¸°</button>
    <audio id="bgm" src="christmas.mp3" loop preload="auto"></audio>

    <div class="stage">
      <img src="tree.png" class="tree" alt="tree">

      <!-- ì „êµ¬(íŠ¸ë¦¬ ìœ„ì— ì˜ˆì˜ê²Œ) -->
      <div class="light" style="left:38%; top:22%; animation-delay:0s;"></div>
      <div class="light" style="left:58%; top:28%; animation-delay:.35s;"></div>
      <div class="light" style="left:46%; top:36%; animation-delay:.7s;"></div>
      <div class="light" style="left:33%; top:48%; animation-delay:1.05s;"></div>
      <div class="light" style="left:62%; top:54%; animation-delay:.55s;"></div>
      <div class="light" style="left:42%; top:62%; animation-delay:.9s;"></div>

      <!-- ì˜¤ë„ˆë¨¼íŠ¸ ìœ„ì¹˜(íŠ¸ë¦¬ ì •ë°©í–¥ ê¸°ì¤€) -->
      <div class="ornament" style="left:50%; top:26%;" data-photo="photo1">
        <div class="string"></div><div class="hook"></div>
        <img src="photo1.jpg" alt="p1">
        <div class="note">âœ‰ï¸</div>
      </div>

      <div class="ornament" style="left:33%; top:56%;" data-photo="photo2">
        <div class="string"></div><div class="hook"></div>
        <img src="photo2.jpg" alt="p2">
        <div class="note">âœ‰ï¸</div>
      </div>

      <div class="ornament" style="left:67%; top:56%;" data-photo="photo3">
        <div class="string"></div><div class="hook"></div>
        <img src="photo3.jpg" alt="p3">
        <div class="note">âœ‰ï¸</div>
      </div>
    </div>

    <div class="hint"> ì—°ì§€ì•¼ ìƒì¼ ì¶•í•˜í•´ </div>
  </div>

  <div class="modalBack" id="modal">
    <div class="modal">
      <div class="top">
        <strong id="title"></strong>
        <button class="close" id="closeBtn">ë‹«ê¸°</button>
      </div>
      <div class="letters" id="letters"></div>
      <div id="formArea">
      <input id="writer" placeholder="ì´ë¦„">
      <textarea id="message" placeholder="ì—°ì§€ì—ê²Œ ë‚¨ê¸¸ í¸ì§€"></textarea>
      <button class="send" id="send">í¸ì§€ ë‚¨ê¸°ê¸°</button>
      </div>

  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import {
  getFirestore, collection, addDoc, query, where, getDocs,
  serverTimestamp, doc, updateDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCZ5tseaOlmlcnZbduKyqo9hsLCiVvIeI4",
  authDomain: "yj-birthday.firebaseapp.com",
  projectId: "yj-birthday",
  storageBucket: "yj-birthday.firebasestorage.app",
  messagingSenderId: "664910382832",
  appId: "1:664910382832:web:e6e2a1cf78d02e2fd66435"
};

const WRITE_KEY = "YJ_TREE_2025_9aK3QzT2";
const urlKey = new URLSearchParams(location.search).get("k") || "";
const canWrite = (urlKey === WRITE_KEY);

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
await signInAnonymously(auth);

// ===== ìŒì•… í† ê¸€ =====
const bgm = document.getElementById("bgm");
const musicBtn = document.getElementById("musicBtn");
let playing = false;

musicBtn.addEventListener("click", async () => {
  try{
    if(!playing){
      await bgm.play();
      playing = true;
      musicBtn.textContent = "ìŒì•… ë„ê¸°";
    }else{
      bgm.pause();
      playing = false;
      musicBtn.textContent = "ìŒì•… ì¼œê¸°";
    }
  }catch(e){
    alert("ì¬ìƒì´ ë§‰í˜”ì–´. ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ì¤˜.");
  }
});

// ===== ëª¨ë‹¬/í¸ì§€ =====
const modal = document.getElementById("modal");
const closeBtn = document.getElementById("closeBtn");
const lettersEl = document.getElementById("letters");
const titleEl = document.getElementById("title");
const formArea = document.getElementById("formArea"); // ì—†ìœ¼ë©´ ì•„ë˜ ì¤„ ì§€ì›Œë„ ë¨
const writerEl = document.getElementById("writer");
const messageEl = document.getElementById("message");
const sendBtn = document.getElementById("send");

let currentPhoto = "";
let editingId = null;

// ë³´ê¸°ì „ìš©ì´ë©´ í¼ ìˆ¨ê¸°ê¸°(ë„ˆê°€ ì›í•˜ëŠ” ì •ì±…)
if(formArea && !canWrite){
  formArea.style.display = "none";
}

// ì˜¤ë„ˆë¨¼íŠ¸ í´ë¦­ â†’ ëª¨ë‹¬ ì—´ê¸°
document.querySelectorAll(".ornament").forEach(o=>{
  o.addEventListener("click", ()=>openModal(o.dataset.photo));
});

function openModal(photo){
  currentPhoto = photo;
  titleEl.textContent = photo + " í¸ì§€";
  modal.style.display = "flex";

  editingId = null;
  if(canWrite) sendBtn.textContent = "í¸ì§€ ë‚¨ê¸°ê¸°";

  loadLetters();
}

function closeModal(){
  modal.style.display = "none";
}
closeBtn.addEventListener("click", closeModal);
modal.addEventListener("click", (e)=>{
  if(e.target === modal) closeModal();
});

function safeText(s){
  return (s || "").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

// ëª©ë¡ ë Œë”
function renderLetters(list){
  if(list.length === 0){
    lettersEl.innerHTML = `<div class="item"><div class="msg">ì•„ì§ í¸ì§€ê°€ ì—†ì–´.</div></div>`;
    return;
  }

  const myUid = auth.currentUser.uid;

  lettersEl.innerHTML = list.map(v=>{
    const canEditMine = canWrite && v.authorUid === myUid;
    return `
  <div class="item">
    <div class="itemTop">
      <div class="meta">${safeText(v.writer)}</div>
      ${canEditMine ? `
        <button class="deleteBtn" data-id="${v.id}" title="ì‚­ì œ">ğŸ—‘ï¸</button>
      ` : ``}
    </div>

    <div class="msg">${safeText(v.message)}</div>

    ${canEditMine ? `
      <button class="editBtn" data-id="${v.id}">ìˆ˜ì •</button>
    ` : ``}
  </div>
`;

  }).join("");
}

// ìˆ˜ì • ë²„íŠ¼ í´ë¦­ â†’ textarea ì±„ìš°ê¸°
lettersEl.addEventListener("click", (e)=>{
  const btn = e.target.closest(".editBtn");
  if(!btn) return;
  if(!canWrite) return;

  const item = btn.closest(".item");
  const meta = item.querySelector(".meta")?.textContent || "ìµëª…";
  const msg  = item.querySelector(".msg")?.textContent || "";

  editingId = btn.dataset.id;
  writerEl.value = meta.trim();
  messageEl.value = msg.trim();
  sendBtn.textContent = "ìˆ˜ì • ì €ì¥";
  messageEl.focus();
});

lettersEl.addEventListener("click", async (e)=>{
  const delBtn = e.target.closest(".deleteBtn");
  if(!delBtn) return;

  if(!canWrite) return;

  const id = delBtn.dataset.id;
  const ok = confirm("ì´ í¸ì§€ë¥¼ ì‚­ì œí• ê¹Œ?");
  if(!ok) return;

  try{
    await deleteDoc(doc(db, "letters", id));
    await loadLetters();
  }catch(err){
    alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message);
  }
});


// í¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°: orderBy ì œê±°(ì¸ë±ìŠ¤ ì—†ì´ ë™ì‘) + JSì—ì„œ ì •ë ¬
async function loadLetters(){
  try{
    const q = query(
      collection(db,"letters"),
      where("photoKey","==",currentPhoto)
    );

    const snap = await getDocs(q);
    const list = [];
    snap.forEach(d=>{
      const v = d.data();
      list.push({
        id: d.id,
        writer: v.writer || "ìµëª…",
        message: v.message || "",
        authorUid: v.authorUid || "",
        createdAtMs: v.createdAt?.toMillis ? v.createdAt.toMillis() : 0
      });
    });

    // ìµœì‹ ìˆœ ì •ë ¬
    list.sort((a,b)=> b.createdAtMs - a.createdAtMs);
    renderLetters(list);

  }catch(e){
    lettersEl.innerHTML = `<div class="item"><div class="msg">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${safeText(e.message)}</div></div>`;
  }
}

// ì €ì¥ / ìˆ˜ì • ì €ì¥
sendBtn.addEventListener("click", async ()=>{
  if(!canWrite){
    alert("ë³´ê¸° ì „ìš© ë§í¬ì•¼. ì“°ê¸° ë§í¬(?k=...)ë¡œ ì ‘ì†í•´ì•¼ í•´.");
    return;
  }

  const writer = writerEl.value.trim() || "ìµëª…";
  const message = messageEl.value.trim();
  if(message.length < 2){
    alert("í¸ì§€ë¥¼ 2ê¸€ì ì´ìƒ ì ì–´ì¤˜");
    return;
  }

  sendBtn.disabled = true;

  try{
    if(editingId){
      await updateDoc(doc(db,"letters", editingId), {
        writer,
        message,
        writeKey: urlKey // Rules í†µê³¼ìš©
      });
      editingId = null;
      sendBtn.textContent = "í¸ì§€ ë‚¨ê¸°ê¸°";
    }else{
      await addDoc(collection(db,"letters"),{
        photoKey: currentPhoto,
        writer,
        message,
        authorUid: auth.currentUser.uid, // ë‚´ ê¸€ë§Œ ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ ì €ì¥
        writeKey: urlKey,                // Rules í†µê³¼ìš©
        createdAt: serverTimestamp()
      });
    }

    messageEl.value = "";
    await loadLetters();

  }catch(e){
    alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
  }finally{
    sendBtn.disabled = false;
  }
});
</script>

