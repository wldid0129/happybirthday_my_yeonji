<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì—°ì§€ì˜ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŠ¸ë¦¬</title>

  <style>
    body{
      margin:0;
      background: linear-gradient(180deg, #fff7cc, #ffefad);
      color:#333;
      font-family: 'Apple SD Gothic Neo','Noto Sans KR',system-ui,sans-serif;
    }
    .wrap{
      max-width: 900px;
      margin: 0 auto;
      padding: 30px 16px 80px;
      text-align:center;
    }
    h1{ margin:10px 0 6px; }
    .sub{ font-size:14px; opacity:.75; margin-bottom:18px; }

    .stage{
      position:relative;
      width:min(520px, 92vw);
      aspect-ratio:1/1.2;
      margin:0 auto;
      background:rgba(255,255,255,.6);
      border-radius:22px;
      box-shadow:0 14px 40px rgba(0,0,0,.15);
      overflow:hidden;
    }
    .tree{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:contain;
    }

    .ornament{
      position:absolute;
      width:90px;
      height:90px;
      border-radius:50%;
      overflow:hidden;
      border:3px solid #fff;
      cursor:pointer;
      box-shadow:0 10px 20px rgba(0,0,0,.2);
      background:#fff;
    }
    .ornament img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .note{
      position:absolute;
      right:-6px;
      bottom:-6px;
      width:30px;
      height:30px;
      border-radius:50%;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      box-shadow:0 6px 14px rgba(0,0,0,.2);
    }

    .modalBack{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .modal{
      width:min(720px, 96vw);
      background:#fff;
      border-radius:18px;
      padding:16px;
      text-align:left;
    }
    .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .close{
      border:0;
      background:#eee;
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
    }
    .letters{
      max-height:280px;
      overflow:auto;
      background:#f7f7f7;
      border-radius:12px;
      padding:10px;
      margin-bottom:10px;
    }
    .item{
      background:#fff;
      border-radius:12px;
      padding:10px;
      margin-bottom:8px;
      font-size:14px;
    }
    .meta{ font-size:12px; opacity:.6; margin-bottom:4px; }
    textarea,input{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid #ccc;
      margin-bottom:8px;
      font-size:14px;
    }
    button.send{
      width:100%;
      padding:10px;
      border-radius:999px;
      border:0;
      background:#333;
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>ğŸ„ ì—°ì§€ì˜ íŠ¸ë¦¬ í¸ì§€í•¨</h1>
  <div class="sub">ì‚¬ì§„ì„ ëˆŒëŸ¬ì„œ í¸ì§€ë¥¼ ë‚¨ê²¨ì¤˜</div>

  <div class="stage">
    <img src="tree.png" class="tree">

    <div class="ornament" style="left:20%;top:25%;" data-photo="photo1">
      <img src="photo1.jpg"><div class="note">âœ‰ï¸</div>
    </div>
    <div class="ornament" style="left:55%;top:35%;" data-photo="photo2">
      <img src="photo2.jpg"><div class="note">âœ‰ï¸</div>
    </div>
    <div class="ornament" style="left:38%;top:60%;" data-photo="photo3">
      <img src="photo3.jpg"><div class="note">âœ‰ï¸</div>
    </div>
  </div>
</div>

<div class="modalBack" id="modal">
  <div class="modal">
    <div class="top">
      <strong id="title"></strong>
      <button class="close" onclick="closeModal()">ë‹«ê¸°</button>
    </div>
    <div class="letters" id="letters"></div>
    <input id="writer" placeholder="ì´ë¦„ ë˜ëŠ” ë³„ëª…">
    <textarea id="message" placeholder="ì—°ì§€ì—ê²Œ ë‚¨ê¸¸ í¸ì§€"></textarea>
    <button class="send" id="send">í¸ì§€ ë‚¨ê¸°ê¸°</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCZ5tseaOlmlcnZbduKyqo9hsLCiVvIeI4",
  authDomain: "yj-birthday.firebaseapp.com",
  projectId: "yj-birthday",
  storageBucket: "yj-birthday.firebasestorage.app",
  messagingSenderId: "664910382832",
  appId: "1:664910382832:web:e6e2a1cf78d02e2fd66435"
};

const WRITE_KEY = "YJ_TREE_2025_9aK3QzT2";
const urlKey = new URLSearchParams(location.search).get("k") || "";
const canWrite = urlKey === WRITE_KEY;

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
await signInAnonymously(auth);

let currentPhoto = "";

document.querySelectorAll(".ornament").forEach(o=>{
  o.onclick = ()=>openModal(o.dataset.photo);
});

async function openModal(photo){
  currentPhoto = photo;
  document.getElementById("title").textContent = photo + " í¸ì§€";
  document.getElementById("modal").style.display = "flex";
  await loadLetters();
}

window.closeModal = ()=> document.getElementById("modal").style.display="none";

async function loadLetters(){
  const q = query(collection(db,"letters"),
    where("photoKey","==",currentPhoto),
    orderBy("createdAt","desc"));
  const snap = await getDocs(q);
  const el = document.getElementById("letters");
  el.innerHTML="";
  snap.forEach(d=>{
    const v=d.data();
    el.innerHTML+=`<div class="item"><div class="meta">${v.writer}</div>${v.message}</div>`;
  });
}

document.getElementById("send").onclick = async ()=>{
  if(!canWrite){ alert("ì“°ê¸° ê¶Œí•œì´ ì—†ì–´ìš”"); return; }
  await addDoc(collection(db,"letters"),{
    photoKey: currentPhoto,
    writer: writer.value||"ìµëª…",
    message: message.value,
    writeKey: WRITE_KEY,
    createdAt: serverTimestamp()
  });
  message.value="";
  await loadLetters();
};
</script>
</body>
</html>

