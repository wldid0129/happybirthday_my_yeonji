<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì—°ì§€ì˜ í¸ì§€í•¨ (ë³´ê¸° ì „ìš©)</title>

  <style>
    body{
      margin:0;
      background: radial-gradient(circle at 20% 10%, rgba(255,255,255,.16), transparent 42%),
                  linear-gradient(135deg, #b81d24 0%, #0b6b3a 100%);
      color:#fff;
      font-family: 'Apple SD Gothic Neo','Noto Sans KR',system-ui,sans-serif;
      overflow-x:hidden;
    }

    #snow{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index: 2;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 28px 16px 80px;
      text-align:center;
      position: relative;
      z-index: 3;
    }

    h1{ margin:10px 0 6px; }
    .sub{ font-size:14px; opacity:.85; margin-bottom:12px; }

    .musicBtn{
      margin: 10px auto 16px;
      padding:10px 14px;
      border:0;
      border-radius:999px;
      background: rgba(255,255,255,.18);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      backdrop-filter: blur(6px);
    }

    .stage{
      position:relative;
      width:min(520px, 92vw);
      aspect-ratio:1/1;
      margin:0 auto;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      border-radius:22px;
      box-shadow:0 18px 50px rgba(0,0,0,.25);
      overflow:hidden;
    }

    .tree{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: contain;
      z-index: 1;
      filter: drop-shadow(0 16px 30px rgba(0,0,0,.22));
    }

    .light{
      position:absolute;
      width:10px;
      height:10px;
      border-radius:50%;
      background: rgba(255,255,255,.95);
      box-shadow: 0 0 14px rgba(255,255,255,.95);
      animation: twinkle 1.4s infinite ease-in-out;
      opacity: .75;
      z-index: 2;
    }
    @keyframes twinkle{
      0%{ transform: scale(.7); opacity:.35; }
      50%{ transform: scale(1.3); opacity:1; }
      100%{ transform: scale(.7); opacity:.35; }
    }

    .treeGlow{
      position:absolute;
      inset:0;
      z-index: 2;
      pointer-events:none;
      background: radial-gradient(circle at 50% 40%, rgba(255,255,255,.20), transparent 55%);
      animation: glowPulse 2.4s ease-in-out infinite;
      mix-blend-mode: screen;
    }
    @keyframes glowPulse{
      0%{ opacity:.25; transform: scale(1); }
      50%{ opacity:.65; transform: scale(1.02); }
      100%{ opacity:.25; transform: scale(1); }
    }

    /* ì˜¤ë„ˆë¨¼íŠ¸: ë³´ê¸° ì „ìš© */
    .ornament{
      position:absolute;
      width:78px;
      height:auto;
      cursor:default;
      z-index: 3;
      transform: translate(-50%, -50%);
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
      pointer-events:none;
    }
    .ornament img{
      width:100%;
      height:auto;
      display:block;
    }
    .note{
      position:absolute;
      right:2px;
      bottom:2px;
      transform: scale(.9);
      width:30px;
      height:30px;
      border-radius:50%;
      background:#fff;
      color:#111;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      box-shadow:0 6px 14px rgba(0,0,0,.25);
    }

    /* ë©”ì¼ë°•ìŠ¤ */
    .mailbox{
      position:absolute;
      left:85%;
      top:86%;
      transform:translate(-50%,-50%);
      width:72px;
      height:72px;
      border-radius:18px;
      background: rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      z-index: 6;
      box-shadow: 0 14px 28px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,.2);
    }
    .mailbox:hover{ transform:translate(-50%,-50%) scale(1.03); }
    .mailbox img{
      width:52px;
      height:52px;
      object-fit: contain;
      display:block;
      pointer-events:none;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.25));
    }

    /* ë¡œê·¸ì¸ íŒ¨ë„ */
    .loginPanel{
      width:min(520px, 92vw);
      margin: 0 auto 14px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.18);
      border-radius:18px;
      padding:12px;
      text-align:left;
      backdrop-filter: blur(8px);
    }
    .loginPanel input{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.22);
      margin-bottom:8px;
      font-size:14px;
      box-sizing:border-box;
      background: rgba(255,255,255,.9);
    }
    .loginPanel button{
      width:100%;
      padding:10px;
      border-radius:999px;
      border:0;
      background:#111;
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
    .loginHint{
      font-size:12px;
      opacity:.85;
      margin-top:8px;
    }

    /* ëª¨ë‹¬ */
    .modalBack{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index: 20;
    }
    .modal{
      width:min(720px, 96vw);
      background: rgba(255,255,255,.96);
      color:#222;
      border-radius:18px;
      padding:16px;
      text-align:left;
      box-shadow: 0 18px 70px rgba(0,0,0,.35);
    }
    .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .close{
      border:0;
      background:#eee;
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
    }

    .letters{
      max-height:260px;
      overflow:auto;
      background:#f7f7f7;
      border-radius:12px;
      padding:10px;
      margin-bottom:10px;
      color:#222;
    }
    .item{
      background:#fff;
      border-radius:12px;
      padding:10px;
      margin-bottom:8px;
      font-size:14px;
    }
    .meta{ font-size:12px; opacity:.6; margin-bottom:4px; }
    .msg{ white-space: pre-line; line-height: 1.7; }

    .envelopes{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .envBtn{
      width:52px;
      height:52px;
      border-radius:14px;
      border:0;
      cursor:pointer;
      background:#fff;
      box-shadow: 0 10px 22px rgba(0,0,0,.15);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:26px;
    }

    .backBtn{
      margin-top:8px;
      border:0;
      padding:7px 10px;
      border-radius:10px;
      cursor:pointer;
      background:#eee;
    }

    .hint{
      margin-top: 12px;
      font-size: 13px;
      opacity: .85;
    }

    /* ìƒíƒœ ë°°ì§€ */
    .statusRow{
      width:min(520px, 92vw);
      margin: 0 auto 10px;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .pill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.14);
      backdrop-filter: blur(8px);
      font-size:13px;
      opacity:.95;
    }
  </style>
</head>

<body>
  <canvas id="snow"></canvas>

  <div class="wrap">
    <h1>ğŸ„ ì—°ì§€ì˜ í¸ì§€í•¨ ğŸ„</h1>
    <div class="sub">ë¡œê·¸ì¸ í›„ ë©”ì¼ë°•ìŠ¤(ğŸ“®)ë¥¼ ëˆ„ë¥´ê³  âœ‰ï¸ë¥¼ ëˆŒëŸ¬ í¸ì§€ë¥¼ í™•ì¸í•´</div>

    <!-- ë¡œê·¸ì¸ ìƒíƒœ í‘œì‹œ + ë¡œê·¸ì•„ì›ƒ -->
    <div class="statusRow">
      <div class="pill" id="authState">ìƒíƒœ: í™•ì¸ ì¤‘...</div>
      <button id="logoutBtn" class="musicBtn" style="margin:0; display:none;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <!-- âœ… ë¡œê·¸ì¸ íŒ¨ë„: ì ˆëŒ€ ìë™ìœ¼ë¡œ ìˆ¨ê¸°ì§€ ì•ŠìŒ -->
    <div class="loginPanel" id="loginPanel" style="display:block;">
      <input id="email" placeholder="ì—°ì§€ ì´ë©”ì¼" autocomplete="username">
      <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password">
      <button id="loginBtn">ë¡œê·¸ì¸</button>
      <div class="loginHint">ë¡œê·¸ì¸ ì„±ê³µ í›„ ë©”ì¼ë°•ìŠ¤ì—ì„œ í¸ì§€ ìŠ¤íƒì´ ë³´ì—¬.</div>
    </div>

    <button id="musicBtn" class="musicBtn">ìŒì•… ì¼œê¸°</button>
    <audio id="bgm" src="christmas.mp3" loop preload="auto"></audio>

    <div class="stage">
      <img src="tree.png" class="tree" alt="tree">
      <div class="treeGlow"></div>

      <div id="mailbox" class="mailbox" title="ì „ì²´ í¸ì§€ ëª¨ì•„ë³´ê¸°">
        <img src="mailbox.png" alt="mailbox">
      </div>

      <div class="light" style="left:38%; top:22%; animation-delay:0s;"></div>
      <div class="light" style="left:58%; top:28%; animation-delay:.35s;"></div>
      <div class="light" style="left:46%; top:36%; animation-delay:.7s;"></div>
      <div class="light" style="left:33%; top:48%; animation-delay:1.05s;"></div>
      <div class="light" style="left:62%; top:54%; animation-delay:.55s;"></div>
      <div class="light" style="left:42%; top:62%; animation-delay:.9s;"></div>

      <div class="ornament" style="left:50%; top:22%;" data-photo="photo1">
        <img src="photo1.png" alt="p1a"><div class="note">âœ‰ï¸</div>
      </div>
      <div class="ornament" style="left:60%; top:47%;" data-photo="photo1">
        <img src="photo2.png" alt="p1b"><div class="note">âœ‰ï¸</div>
      </div>
      <div class="ornament" style="left:40%; top:47%;" data-photo="photo2">
        <img src="photo3.png" alt="p2a"><div class="note">âœ‰ï¸</div>
      </div>
      <div class="ornament" style="left:30%; top:70%;" data-photo="photo2">
        <img src="photo3.png" alt="p2b"><div class="note">âœ‰ï¸</div>
      </div>
      <div class="ornament" style="left:50%; top:70%;" data-photo="photo3">
        <img src="photo1.png" alt="p3a"><div class="note">âœ‰ï¸</div>
      </div>
      <div class="ornament" style="left:70%; top:70%;" data-photo="photo3">
        <img src="photo2.png" alt="p3b"><div class="note">âœ‰ï¸</div>
      </div>
    </div>

    <div class="hint">ì—°ì§€ì•¼ ìƒì¼ ì¶•í•˜í•´</div>
  </div>

  <!-- ëª¨ë‹¬ -->
  <div class="modalBack" id="modal">
    <div class="modal">
      <div class="top">
        <strong id="title"></strong>
        <button class="close" id="closeBtn">ë‹«ê¸°</button>
      </div>

      <div class="letters" id="letters"></div>

      <div id="envelopeArea" style="display:none;">
        <div class="envelopes" id="envelopes"></div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getAuth, setPersistence, browserSessionPersistence,
    signInWithEmailAndPassword, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import {
    getFirestore, collection, onSnapshot, query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCZ5tseaOlmlcnZbduKyqo9hsLCiVvIeI4",
    authDomain: "yj-birthday.firebaseapp.com",
    projectId: "yj-birthday",
    storageBucket: "yj-birthday.firebasestorage.app",
    messagingSenderId: "664910382832",
    appId: "1:664910382832:web:e6e2a1cf78d02e2fd66435"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  await setPersistence(auth, browserSessionPersistence);
  const db = getFirestore(app);

  function safeText(s){
    return (s || "").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  // ===== ìŒì•… í† ê¸€ =====
  const bgm = document.getElementById("bgm");
  const musicBtn = document.getElementById("musicBtn");
  let playing = false;

  musicBtn.addEventListener("click", async () => {
    try{
      if(!playing){
        await bgm.play();
        playing = true;
        musicBtn.textContent = "ìŒì•… ë„ê¸°";
      }else{
        bgm.pause();
        playing = false;
        musicBtn.textContent = "ìŒì•… ì¼œê¸°";
      }
    }catch(e){
      alert("ì¬ìƒì´ ë§‰í˜”ì–´. ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ì¤˜.");
    }
  });

  // ===== ëª¨ë‹¬ =====
  const modal = document.getElementById("modal");
  const closeBtn = document.getElementById("closeBtn");
  const titleEl = document.getElementById("title");
  const lettersEl = document.getElementById("letters");
  const envelopeArea = document.getElementById("envelopeArea");
  const envelopesEl = document.getElementById("envelopes");
  const mailbox = document.getElementById("mailbox");

  function openModalBase(title){
    titleEl.textContent = title;
    modal.style.display = "flex";
  }
  function closeModal(){
    modal.style.display = "none";
  }
  closeBtn.addEventListener("click", closeModal);
  modal.addEventListener("click", (e)=>{
    if(e.target === modal) closeModal();
  });

  function showNeedLogin(){
    openModalBase("ë¡œê·¸ì¸ì´ í•„ìš”í•´");
    envelopeArea.style.display = "none";
    lettersEl.style.display = "block";
    lettersEl.innerHTML = `<div class="item"><div class="msg">ì—°ì§€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì•¼ í¸ì§€ë¥¼ ë³¼ ìˆ˜ ìˆì–´.</div></div>`;
  }

  // ===== ë¡œê·¸ì¸/ìƒíƒœ =====
  const authStateEl = document.getElementById("authState");
  const logoutBtn = document.getElementById("logoutBtn");

  let loggedIn = false;

  onAuthStateChanged(auth, (user)=>{
    loggedIn = !!user;
    authStateEl.textContent = loggedIn ? "ìƒíƒœ: ë¡œê·¸ì¸ë¨" : "ìƒíƒœ: ë¡œê·¸ì•„ì›ƒë¨";
    logoutBtn.style.display = loggedIn ? "inline-block" : "none";
    // âœ… loginPanelì€ ì ˆëŒ€ ìë™ ìˆ¨ê¹€í•˜ì§€ ì•ŠìŒ (ì‚¬ìš©ìê°€ ë³´ê¸° í¸í•˜ê²Œ ìœ ì§€)
  });

  document.getElementById("loginBtn").addEventListener("click", async ()=>{
    try{
      const email = document.getElementById("email").value.trim();
      const pw = document.getElementById("password").value.trim();

      if(!email || !pw){
        alert("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      await signInWithEmailAndPassword(auth, email, pw);
      alert("ë¡œê·¸ì¸ ì™„ë£Œ! ë©”ì¼ë°•ìŠ¤ë¥¼ ëˆŒëŸ¬ í¸ì§€ë¥¼ í™•ì¸í•´ë´.");
    }catch(e){
      alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + (e?.message || e));
    }
  });

  logoutBtn.addEventListener("click", async ()=>{
    try{
      await signOut(auth);
      alert("ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ");
    }catch(e){
      alert("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: " + (e?.message || e));
    }
  });

  // ===== ì‹¤ì‹œê°„ í¸ì§€ =====
  let unsubAll = null;
  let allLettersCache = [];

  function renderEnvelopeStack(list){
    if(list.length === 0){
      envelopesEl.innerHTML = `<div class="item"><div class="msg">ì•„ì§ ë„ì°©í•œ í¸ì§€ê°€ ì—†ì–´.</div></div>`;
      return;
    }
    envelopesEl.innerHTML = list.map(x=>`
      <button class="envBtn" data-id="${x.id}" title="${safeText(x.writer)}">âœ‰ï¸</button>
    `).join("");
  }

  function renderOneLetter(x){
    lettersEl.innerHTML = `
      <div class="item">
        <div class="meta">${safeText(x.writer)}</div>
        <div class="msg">${safeText(x.message)}</div>
        <div class="meta">${x.createdAtMs ? new Date(x.createdAtMs).toLocaleString('ko-KR') : ''}</div>
        <button class="backBtn" id="backToStack">â¬…ï¸ í¸ì§€ ëª©ë¡(âœ‰ï¸)ìœ¼ë¡œ</button>
      </div>
    `;
  }

  function startAllLettersRealtime(){
    if(unsubAll) unsubAll();

    const q = query(collection(db,"letters"), orderBy("createdAt","desc"));

    unsubAll = onSnapshot(q, (snap)=>{
      const list = [];
      snap.forEach(d=>{
        const v = d.data();
        list.push({
          id: d.id,
          writer: v.writer || "ìµëª…",
          message: v.message || "",
          photoKey: v.photoKey || "",
          createdAtMs: v.createdAt?.toMillis ? v.createdAt.toMillis() : 0
        });
      });

      list.sort((a,b)=> (b.createdAtMs||0) - (a.createdAtMs||0));
      allLettersCache = list;

      if(envelopeArea.style.display !== "none"){
        renderEnvelopeStack(allLettersCache);
      }
    }, (err)=>{
      envelopesEl.innerHTML = `<div class="item"><div class="msg">ì‹¤ì‹œê°„ ì—°ê²° ì‹¤íŒ¨: ${safeText(err?.message || err)}</div></div>`;
    });
  }

  // ===== ë©”ì¼ë°•ìŠ¤ í´ë¦­ =====
  mailbox.addEventListener("click", ()=>{
    if(!loggedIn){ showNeedLogin(); return; }

    openModalBase("ğŸ“® ì „ì²´ í¸ì§€í•¨");

    lettersEl.style.display = "none";
    envelopeArea.style.display = "block";
    envelopesEl.innerHTML = `<div class="item"><div class="msg">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>`;

    startAllLettersRealtime();
  });

  // ===== âœ‰ï¸ í´ë¦­ =====
  envelopesEl.addEventListener("click", (e)=>{
    const b = e.target.closest(".envBtn");
    if(!b) return;

    const found = allLettersCache.find(v=>v.id === b.dataset.id);
    if(!found) return;

    envelopeArea.style.display = "none";
    lettersEl.style.display = "block";
    renderOneLetter(found);
  });

  // ===== ë’¤ë¡œê°€ê¸° =====
  lettersEl.addEventListener("click", (e)=>{
    if(!e.target.closest("#backToStack")) return;
    lettersEl.style.display = "none";
    envelopeArea.style.display = "block";
    renderEnvelopeStack(allLettersCache);
  });

  // ===== ëˆˆ ë‚´ë¦¬ëŠ” íš¨ê³¼(Canvas) =====
  const canvas = document.getElementById("snow");
  const ctx = canvas.getContext("2d");

  let W = 0, H = 0;
  function resizeSnow(){
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resizeSnow);
  resizeSnow();

  const flakes = [];
  function rebuildFlakes(){
    flakes.length = 0;
    const count = Math.min(160, Math.floor((W * H) / 12000));
    for(let i=0;i<count;i++){
      flakes.push({
        x: Math.random() * W,
        y: Math.random() * H,
        r: Math.random() * 2.2 + 0.7,
        vx: Math.random() * 0.6 - 0.3,
        vy: Math.random() * 1.3 + 0.5,
        a: Math.random() * 0.55 + 0.25,
        wob: Math.random() * 3.14
      });
    }
  }
  rebuildFlakes();
  window.addEventListener("resize", rebuildFlakes);

  function snowTick(){
    ctx.clearRect(0,0,W,H);

    for(const f of flakes){
      f.wob += 0.02;
      f.x += f.vx + Math.sin(f.wob) * 0.25;
      f.y += f.vy;

      if(f.y > H + 10){ f.y = -10; f.x = Math.random() * W; }
      if(f.x > W + 10) f.x = -10;
      if(f.x < -10) f.x = W + 10;

      ctx.globalAlpha = f.a;
      ctx.beginPath();
      ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
      ctx.fillStyle = "#ffffff";
      ctx.fill();
    }

    ctx.globalAlpha = 1;
    requestAnimationFrame(snowTick);
  }
  snowTick();
</script>
</body>
</html>
